<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/configuration.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/configuration.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import models from '../models'
import Helpers from '../helpers'

/**
 * Controller for Configuration TEMS Message.
 * Creates/Updates a Tester with the given information
 * Configuration message includes boards and slots
 *
 * @method configurationController
 * @memberof Controllers
 * @param  {Request} req - Incoming Request
 * @param  {Response} res - Outgoing Response
 */
const configurationController = (req, res) => {

  console.log(req.originalUrl)
  res.sendStatus(200)
  console.log('Tester: ', req.params.testerName)

  // foreach board, create a slot, add the board to the slot.
  // Gather the set of boards, then add it as a set to the tester with Tester.setSlots
  const testerPromise = Helpers.upsert(models.Tester, {
    name: req.params.testerName,
  },
  {
    name: req.params.testerName,
  })

  Promise.resolve(testerPromise)
    .then(testerObject => testerObject.update({
      name: req.params.testerName,
      igxlVersion: req.body.TESTER_CONTROLLER_SW.Version,
      model: req.body.TESTER_MODEL,
    })
      .then((updatedTesterObject) => {
        req.body.BOARD.forEach((configBoard) => {
          const slotPromise = Helpers.upsert(models.Slot, {
            slotNumber: configBoard.SLOT,
          }, {
            tester_id: updatedTesterObject.id, slotNumber: configBoard.SLOT,
          })
          Promise.resolve(slotPromise)
            .then((slotObject) => {
              // console.log('Inserting Slot: ', configBoard.SLOT)
              const boardPromise = Helpers.upsert(models.Board, {
                boardId: configBoard.BOARD_ID,
                name: configBoard.NAME,
                partNumber: configBoard.PART_NUMBER,
                rev: configBoard.REV,
                sector: configBoard.SECTOR,
                slotNumber: configBoard.SLOT,
                testerName: req.params.testerName,
              },
              {
                slotNumber: configBoard.SLOT,
                testerName: req.params.testerName,
              })
              Promise.resolve(boardPromise)
                .then((boardObject) => {
                  slotObject.addBoards(boardObject)
                    .then(() => updatedTesterObject.addSlots(slotObject))
                    .catch(error => console.log('Error updating slots\n', error))
                })
                .catch(error => console.log('Error inserting board in slot', slotObject.slotNumber, 'as slot id:', slotObject.id, '\n', error))
              return null
            })
            .catch(error => console.log('Error inserting board in the tester', testerObject.name, 'as slot:', configBoard.SLOT, '\n', error))
        })
        return null
      })
      .catch(error => console.log('Error retrieving tester\n', error)))
    .catch(error => console.log('Error\n', error))
}

export default configurationController
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Controllers_maintenanceController.html">Controllers/maintenanceController</a></li></ul><h3>Namespaces</h3><ul><li><a href="Controllers.html">Controllers</a></li><li><a href="Helpers.html">Helpers</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Jul 16 2018 22:49:49 GMT-0400 (Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
